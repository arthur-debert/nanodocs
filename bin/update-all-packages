#!/bin/bash
# Script to update both Homebrew and APT packages in non-interactive mode

set -e

# Get the directory of the current script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Check if force update is requested
FORCE_FLAG=""
if [[ "$1" == "--force" ]]; then
    FORCE_FLAG="--force"
fi

echo "Updating Homebrew package..."
"$PROJECT_ROOT/package-managers/brew/update-brew-formula.sh" --non-interactive $FORCE_FLAG

echo ""
echo "Updating APT package..."

# Check if we're on a Debian-based system
if [ -f /etc/debian_version ]; then
    # We're on a Debian-based system, so we can build the package locally
    "$PROJECT_ROOT/package-managers/debian/update-apt-package.sh" --non-interactive $FORCE_FLAG
else
    # We're not on a Debian-based system, so we'll just trigger the workflow
    echo "Not on a Debian-based system, triggering the APT package update workflow directly..."

    # Get the current branch
    BRANCH=$(git branch --show-current)

    # Get the package name
    PACKAGE_NAME="nanodoc"

    # Determine if we should force the update
    FORCE_UPDATE="false"
    if [[ "$FORCE_FLAG" == "--force" ]]; then
        FORCE_UPDATE="true"
    fi

    # Trigger the workflow
    gh workflow run "Update APT Package" --ref "${BRANCH}" --field force_update=${FORCE_UPDATE} --field package_name=${PACKAGE_NAME}
fi

echo ""
echo "Both package updates have been triggered."
